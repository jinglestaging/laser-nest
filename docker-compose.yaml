name: foundry-app  # Project name for Docker Desktop

services:
  foundry-backend:
    container_name: foundry-backend
    image: ghcr.io/jinglestaging/01-foundry-backend/foundry-backend:${BACKEND_IMAGE_TAG:-latest}
    ports:
      - "5004:5004"  # Hardcode external/internal to 5004 (ignores .env PORT for Docker)
    environment:
      - NODE_ENV=${NODE_ENV:-development}
      - PORT=5004  # Override: App listens on 5004 internally (overrides .env PORT=3004)
      - SUPABASE_URL=${SUPABASE_URL}
      - SUPABASE_SERVICE_KEY=${SUPABASE_SERVICE_KEY}
      - CORS_ORIGIN=${CORS_ORIGIN:-http://localhost:5004}
    env_file: .env
    networks:
      - foundry-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "curl --fail http://localhost:5004/health || exit 1"]  # Hardcode to 5004 (no need for $$PORT now)
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    volumes:
      - ./logs:/app/logs

networks:
  foundry-network:
    driver: bridge